<!doctype html>
<html>

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<title>Bar Chart</title>
	<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/9.3.0/math.js"></script>

	<style>
		canvas {
			-moz-user-select: none;
			-webkit-user-select: none;
			-ms-user-select: none;
		}

		div {
			margin: 10px;
		}
	</style>
</head>

<body>
	<div>
		<table>
			<tr>
				<td>확률</td>
				<td>:</td>
				<td><input type="number" id="probNum" value="5" min="0.000" max="100.000" step="0.001"
						style="width: 50px; text-align: right;" onchange="mainInputUpdate()" />% (0.000 ~ 100.000)</td>
			</tr>
			<tr>
				<td>시행 횟수</td>
				<td>:</td>
				<td><input type="number" id="tryNum" value="10" min="0" style="width: 50px; text-align: right;"
						onchange="mainInputUpdate()" />회</td>
			</tr>
		</table>
	</div>

	<div id="chartTitle" style="text-align:center; font-weight: bold;"></div>

	<div id="container" style="width: 90%; margin: auto;">
		<canvas id="canvas"></canvas>
	</div>
	<div>
		<table>
			<tr>
				<td>구간</td>
				<td>:</td>
				<td>
					<input type="number" id="frontExpectNum" style="width: 50px; text-align: right;"
						onchange="frontExpectUpdate();" />
				</td>
				<td>~</td>
				<td>
					<input type="number" id="backExpectNum" style="width: 50px; text-align: right;"
						onchange="backExpectUpdate();" />
				</td>
			</tr>
		</table>
	</div>

	<div id="viewCustomTooltip"></div>

	<script>
		var probData;
		var probNum;
		var tryNum;
		var viewFrontExpectNum;
		var viewBackExpectNum;
		var minFrontExpectNum;
		var maxBackExpectNum;
		var distanceNum;
		var viewPercent = true;
		

		function initNumVal() {
			probNum = Number(document.getElementById("probNum").value) / 100.0
			tryNum = Number(document.getElementById("tryNum").value)
			viewBackExpectNum = Number(document.getElementById("backExpectNum").value)
			viewFrontExpectNum = Number(document.getElementById("frontExpectNum").value)
			distanceNum = Number(document.getElementById("frontExpectNum").value)
		}

		var barChartData;

		var chartColor = Chart.helpers.color;
		var myChart;
		var ctx = document.getElementById('canvas').getContext('2d');

		chartColors = {
			red: 'rgb(255, 99, 132)',
			orange: 'rgb(255, 159, 64)',
			yellow: 'rgb(255, 205, 86)',
			green: 'rgb(75, 192, 192)',
			blue: 'rgb(54, 162, 235)',
			purple: 'rgb(153, 102, 255)',
			grey: 'rgb(201, 203, 207)'
		};

		init();


		function init() {
			initNumVal()

			probData = calcurateProbValues(probNum, tryNum)

			var fbValObj = getFrontBackVal(probData)

			// var backExpectNum = Number(document.getElementById("backExpectNum").value)
			var backExpectNum = fbValObj.backSetNum
			viewBackExpectNum = fbValObj.backSetNum
			// maxBackExpectNum = fbValObj.backSetNum + distanceNum

			var frontExpectNum = fbValObj.frontSetNum
			viewFrontExpectNum = fbValObj.frontSetNum
			// minFrontExpectNum = fbValObj.frontSetNum - distanceNum

			barChartData = {
				// labels: [...Array(backExpectNum + 1).keys()],
				labels: range(fbValObj.frontSetNum, fbValObj.backSetNum),
				datasets: [{
					// label: 'Dataset 1',
					backgroundColor: chartColor(chartColors.blue).alpha(0.5).rgbString(),
					borderColor: chartColors.blue,
					borderWidth: 1,
					data: fbValObj.sliceArrayData
				}]
			};

			chartOpt = setChartOption();
			myChart = new Chart(ctx, chartOpt);

			distanceNum = fbValObj.frontSetNum;
			minFrontExpectNum = fbValObj.frontSetNum - distanceNum
			maxBackExpectNum = fbValObj.backSetNum + distanceNum

			modifyDataTitle()
		}

		function modifyDataTitle() {
			// document.getElementById("chartTitle").innerText = '확률 : ' + Number((probNum * 100).toFixed(3)) + '% , ' + tryNum + '회 시행';
			myChart.options.title.text = '확률 : ' + Number((probNum * 100).toFixed(3)) + '% , ' + tryNum + '회 시행';
		}

		function setChartOption() {
			var opt = {
				type: 'bar',
				data: barChartData,
				options: {
					responsive: true,
					legend: {
						// position: 'top',
						display: false
					},
					title: {
						display: true,
						fontColor: '#000000',
						fontSize: 15,
						// text: '확률 : ' + Number((probNum * 100).toFixed(3)) + '% , ' + tryNum + '회 시행'
					},
					scales: {
						yAxes: [{
							scaleLabel: {
								display: true,
								labelString: '확률'
							},
							ticks: {
								// Include a dollar sign in the ticks
								callback: function(value, index, values) {
									return value + '%';
								}
							}
						}],
						xAxes: [{
							scaleLabel: {
								display: true,
								labelString: '갯수'
							},
						}]
					},
					tooltips: {
						// Disable the on-canvas tooltip
						// enabled: true,
						displayColors: false,
						callbacks: {
							title: function() {},
							label: function(tooltipItem) {
								return Number(tooltipItem.yLabel) + "%";
							},
						},

					// 	custom: function (tooltipModel) {
					// 		// Tooltip Element
					// 		var tooltipEl = document.getElementById('chartjs-tooltip');
					// 		// var tooltipEl = document.getElementById("viewCustomTooltip") //document.getElementById('chartjs-tooltip');
					// 		// tooltipEl.innerHTML = '<table></table>';

					// 		// Create element on first render
					// 		if (!tooltipEl) {
					// 			tooltipEl = document.createElement('div');
					// 			tooltipEl.id = 'chartjs-tooltip';
					// 			tooltipEl.innerHTML = '<table></table>';
					// 			document.body.appendChild(tooltipEl);
					// 		}

					// 		// Hide if no tooltip
					// 		if (tooltipModel.opacity === 0) {
					// 			tooltipEl.style.opacity = 0;
					// 			return;
					// 		}

					// 		// Set caret Position
					// 		tooltipEl.classList.remove('above', 'below', 'no-transform');
					// 		if (tooltipModel.yAlign) {
					// 			tooltipEl.classList.add(tooltipModel.yAlign);
					// 		} else {
					// 			tooltipEl.classList.add('no-transform');
					// 		}

					// 		function getBody(bodyItem) {
					// 			return bodyItem.lines;
					// 		}

					// 		// Set Text
					// 		if (tooltipModel.body) {
					// 			var titleLines = tooltipModel.title || [];
					// 			var bodyLines = tooltipModel.body.map(getBody);

					// 			var innerHtml = '<thead>';

					// 			titleLines.forEach(function (title) {
					// 				innerHtml += '<tr><th>' + title + '</th></tr>';
					// 			});
					// 			innerHtml += '</thead><tbody>';

					// 			bodyLines.forEach(function (body, i) {
					// 				var colors = tooltipModel.labelColors[i];
					// 				var style = 'background:' + colors.backgroundColor;
					// 				style += '; border-color:' + colors.borderColor;
					// 				style += '; border-width: 2px';
					// 				var span = '<span style="' + style + '"></span>';
					// 				innerHtml += '<tr><td>' + span + body + '</td></tr>';
					// 			});
					// 			innerHtml += '</tbody>';

					// 			var tableRoot = tooltipEl.querySelector('table');
					// 			tableRoot.innerHTML = innerHtml;
					// 		}

					// 		// `this` will be the overall tooltip
					// 		var position = this._chart.canvas.getBoundingClientRect();

					// 		// Display, position, and set styles for font
					// 		tooltipEl.style.opacity = 1;
					// 		tooltipEl.style.position = 'absolute';
					// 		tooltipEl.style.left = position.left + window.pageXOffset + tooltipModel.caretX + 'px';
					// 		tooltipEl.style.top = position.top + window.pageYOffset + tooltipModel.caretY + 'px';
					// 		tooltipEl.style.fontFamily = tooltipModel._bodyFontFamily;
					// 		tooltipEl.style.fontSize = tooltipModel.bodyFontSize + 'px';
					// 		tooltipEl.style.fontStyle = tooltipModel._bodyFontStyle;
					// 		tooltipEl.style.padding = tooltipModel.yPadding + 'px ' + tooltipModel.xPadding + 'px';
					// 		tooltipEl.style.pointerEvents = 'none';
					// 	}
					},
					hover: {
						animationDuration: 0
					},
					animation: {
						// duration: 0,
						onComplete: function () {
							if (viewPercent == true) {
								var chartInstance = this.chart,
									ctx = chartInstance.ctx;
								ctx.font = Chart.helpers.fontString(Chart.defaults.global.defaultFontSize,
									Chart.defaults.global.defaultFontStyle, Chart.defaults.global.defaultFontFamily);
								ctx.textAlign = 'center';
								ctx.textBaseline = 'bottom';

								this.data.datasets.forEach(function (dataset, i) {
									var meta = chartInstance.controller.getDatasetMeta(i);
									meta.data.forEach(function (bar, index) {
										var data = dataset.data[index];
										if(data > 0) {
											ctx.fillText(data + "%", bar._model.x, bar._model.y - 5);
										}									
									});
								});
							}
							
						}
					}
				}
			}

			return opt
		}

		function calcurateProbValues(probNum, tryNum) {
			var dataList = []

			for (var i = 0; i <= tryNum; i++) {
				var comb = math.bignumber(math.combinations(math.bignumber(tryNum), math.bignumber(i)));
				var p = math.pow(math.bignumber(probNum), math.bignumber(i));
				var q = math.pow(math.bignumber(1.0 - probNum), math.bignumber(tryNum - i));

				var res = math.bignumber(comb * p * q * 100);

				res = Number(res.toFixed(3));

				if (isFinite(res) == false) {
					res = 0;
				}

				dataList.push(res);
			}
			return dataList;
		}

		function range(start, end) {
			var foo = [];
			for (var i = start; i <= end; i++) {
				foo.push(i);
			}
			return foo;
		}

		function mainInputUpdate() {
			initNumVal()

			var backExpectNum = Number(document.getElementById("backExpectNum").value)
			probData = calcurateProbValues(probNum, tryNum)

			var fbValObj = getFrontBackVal(probData);


			var sliceLabel = range(fbValObj.frontSetNum, fbValObj.backSetNum);
			barChartData.labels = sliceLabel;
			viewFrontExpectNum = fbValObj.frontSetNum;
			viewBackExpectNum = fbValObj.backSetNum;

			myChart.data.datasets[0].data = fbValObj.sliceArrayData

			myChart.update();

			distanceNum = fbValObj.frontSetNum;
			minFrontExpectNum = fbValObj.frontSetNum - distanceNum;
			maxBackExpectNum = fbValObj.backSetNum + distanceNum;

			modifyDataTitle();
		}

		function getFrontBackVal(dataArray) {
			var highestVal = Math.max(...dataArray);
			var highestIndex = dataArray.indexOf(highestVal)

			var arrFront = dataArray.slice(0, highestIndex)
			var arrBack = dataArray.slice(highestIndex)

			var frontZeroIndex = arrFront.lastIndexOf(0)
			var backZeroIndex = arrBack.indexOf(0)

			if (frontZeroIndex != -1) {
				var frontSetNum = frontZeroIndex
			}
			else if (frontZeroIndex == -1) {
				var frontSetNum = 0
			}
			document.getElementById("frontExpectNum").value = frontSetNum

			if (backZeroIndex != -1) {
				var backSetNum = highestIndex + backZeroIndex
			}
			else if (backZeroIndex == -1) {
				var backSetNum = dataArray.length - 1
			}
			document.getElementById("backExpectNum").value = backSetNum

			var sliceArrayData = dataArray.slice(frontSetNum, backSetNum + 1)

			var resObj = {
				frontZeroIndex: frontZeroIndex,
				backZeroIndex: backZeroIndex,
				frontSetNum: frontSetNum,
				backSetNum: backSetNum,
				sliceArrayData: sliceArrayData
			}

			return resObj
		}

		function frontExpectUpdate() {
			var frontExpectNum = Number(document.getElementById("frontExpectNum").value)

			var frontExpectNum = chkNumRange(frontExpectNum, minFrontExpectNum, viewBackExpectNum)
			document.getElementById("frontExpectNum").value = frontExpectNum

			// console.log(frontExpectNum, viewFrontExpectNum, minFrontExpectNum, maxBackExpectNum)

			if (frontExpectNum < viewFrontExpectNum) {
				for (var i = 0; i < viewFrontExpectNum - frontExpectNum; i++) {
					barChartData.labels.unshift(viewFrontExpectNum - i - 1);
					barChartData.datasets[0].data.unshift(probData[viewFrontExpectNum - i - 1]);
				}
			}
			else if (frontExpectNum > viewFrontExpectNum) {
				for (var i = 0; i < frontExpectNum - viewFrontExpectNum; i++) {
					barChartData.labels.shift();
					barChartData.datasets[0].data.shift();
				}
			}

			myChart.update();
			viewFrontExpectNum = frontExpectNum;
		}

		function backExpectUpdate() {
			var backExpectNum = Number(document.getElementById("backExpectNum").value)

			var backExpectNum = chkNumRange(backExpectNum, viewFrontExpectNum, maxBackExpectNum)
			document.getElementById("backExpectNum").value = backExpectNum

			if (backExpectNum > viewBackExpectNum) {
				for (var i = 0; i < backExpectNum - viewBackExpectNum; i++) {
					barChartData.labels.push(viewBackExpectNum + i + 1);
					barChartData.datasets[0].data.push(probData[viewBackExpectNum + i + 1]);
				}
			}
			else if (backExpectNum < viewBackExpectNum) {
				for (var i = 0; i < viewBackExpectNum - backExpectNum; i++) {
					barChartData.labels.pop();
					barChartData.datasets[0].data.pop();
				}
			}

			myChart.update();
			viewBackExpectNum = backExpectNum;
		}

		function chkNumRange(target, min, max) {
			var num = target;
			if (target < min) {
				num = min
			}

			if (target > max) {
				num = max
			}
			return num
		}

	</script>
</body>

</html>